<?php
session_start();

use PHPMailer\PHPMailer\PHPMailer;
use PHPMailer\PHPMailer\Exception;

require_once "PHPMailer/PHPMailer.php";
require_once "PHPMailer/SMTP.php";
require_once "PHPMailer/Exception.php";

require_once __DIR__ . '/../db/db.php';

header('Content-Type: application/json');

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ login ‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
if (!isset($_SESSION['member_id'])) {
    echo json_encode(['success' => false, 'message' => '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö']);
    exit;
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô POST request ‡πÅ‡∏•‡∏∞‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
if ($_SERVER['REQUEST_METHOD'] !== 'POST' || !isset($_POST['booking_id']) || !isset($_FILES['slip'])) {
    echo json_encode(['success' => false, 'message' => '‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á']);
    exit;
}

$booking_id = (int)$_POST['booking_id'];
$member_id = (int)$_SESSION['member_id'];
$slip_file = $_FILES['slip'];

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î
if ($slip_file['error'] !== UPLOAD_ERR_OK) {
    echo json_encode(['success' => false, 'message' => '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå']);
    exit;
}

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏à‡∏£‡∏¥‡∏á
$stmt_check = $conn->prepare("SELECT bookings_id, booking_code, guest_name FROM bookings WHERE bookings_id = ? AND member_id = ?");
$stmt_check->bind_param("ii", $booking_id, $member_id);
$stmt_check->execute();
$result_check = $stmt_check->get_result();
if ($result_check->num_rows === 0) {
    echo json_encode(['success' => false, 'message' => '‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏™‡∏¥‡∏ó‡∏ò‡∏¥‡πå‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÄ‡∏Ç‡πâ‡∏≤‡∏ñ‡∏∂‡∏á‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡∏ô‡∏µ‡πâ']);
    exit;
}
$booking_details = $result_check->fetch_assoc();

function sendAdminSlipNotification($booking_id, $booking_code, $guest_name, $slip_path, $slip_filename) {
    $adminMail = new PHPMailer(true);
    try {
        // ... (‡πÇ‡∏Ñ‡πâ‡∏î PHPMailer ‡∏ó‡∏µ‡πà‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏≠‡∏¢‡∏π‡πà‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á)
    } catch (Exception $e) {
        // ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏™‡∏Ñ‡∏£‡∏¥‡∏õ‡∏ï‡πå‡∏´‡∏•‡∏±‡∏Å ‡πÅ‡∏Ñ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å error
        error_log("Mailer Error: {$adminMail->ErrorInfo}");
    }
}
$stmt_check->close();

// ‡∏Å‡∏≥‡∏´‡∏ô‡∏î path ‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡πÉ‡∏´‡∏°‡πà
$upload_dir = __DIR__ . '/Paymentslip-Gardenreservation/';
if (!is_dir($upload_dir)) {
    mkdir($upload_dir, 0755, true);
}

$file_extension = pathinfo($slip_file['name'], PATHINFO_EXTENSION);
$new_filename = 'slip_' . $booking_id . '_' . time() . '.' . $file_extension;
$upload_path = $upload_dir . $new_filename;

// ‡∏¢‡πâ‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏õ‡∏¢‡∏±‡∏á‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£
if (move_uploaded_file($slip_file['tmp_name'], $upload_path)) {
    // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•
    $stmt_update = $conn->prepare("UPDATE bookings SET payment_slip = ? WHERE bookings_id = ?");
    if ($stmt_update) {
        $stmt_update->bind_param("si", $new_filename, $booking_id);

        // ‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Admin
        try {
            $adminMail = new PHPMailer(true);
            $adminMail->isSMTP();
            $adminMail->Host       = "smtp.gmail.com";
            $adminMail->SMTPAuth   = true;
            $adminMail->Username   = "nanoone342@gmail.com";
            $adminMail->Password   = "cmlt zqfp jveg jxoi"; // App Password
            $adminMail->Port       = 465;
            $adminMail->SMTPSecure = "ssl";
            $adminMail->CharSet    = 'UTF-8';

            $adminMail->setFrom('nanoone342@gmail.com', '‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏≠‡∏á‡∏Ñ‡∏¥‡∏ß');
            $adminMail->addAddress('nanoone342@gmail.com'); // ‡∏≠‡∏µ‡πÄ‡∏°‡∏• Admin

            // ‡πÅ‡∏ô‡∏ö‡πÑ‡∏ü‡∏•‡πå‡∏™‡∏•‡∏¥‡∏õ
            $adminMail->addEmbeddedImage($upload_path, 'slip_image', $new_filename);

            $adminMail->isHTML(true);
            $adminMail->Subject = "üßæ [‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà] ‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Booking: " . ($booking_details['booking_code'] ?? $booking_id);
            $adminMail->Body    = "
                <div style='font-family: Kanit, sans-serif; padding: 20px; background-color: #f4f4f4;'>
                    <div style='max-width: 600px; margin: auto; background: white; padding: 20px; border-radius: 8px;'>
                        <h2 style='color: #016A70;'>‡∏°‡∏µ‡∏™‡∏•‡∏¥‡∏õ‡πÉ‡∏´‡∏°‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏£‡∏∞‡∏ö‡∏ö</h2>
                        <p>‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏ó‡∏≥‡∏Å‡∏≤‡∏£‡πÅ‡∏ô‡∏ö‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á:</p>
                        <ul>
                            <li><strong>‡∏£‡∏´‡∏±‡∏™‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á:</strong> " . htmlspecialchars($booking_details['booking_code'] ?? 'N/A') . "</li>
                            <li><strong>‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏à‡∏≠‡∏á:</strong> " . htmlspecialchars($booking_details['guest_name'] ?? 'N/A') . "</li>
                            <li><strong>Booking ID:</strong> " . $booking_id . "</li>
                        </ul>
                        <p style='margin-bottom: 15px; font-weight: bold; color: #016A70; text-align: center;'>‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô</p>
                        <img src='cid:slip_image' alt='Payment Slip' style='max-width: 100%; height: auto; display: block; margin: 0 auto; border: 1px solid #eee; border-radius: 4px;'>
                        </ul>
                        <p>‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏≠‡∏á‡∏™‡∏•‡∏¥‡∏õ (‡πÅ‡∏ô‡∏ö‡πÉ‡∏ô‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ) ‡πÅ‡∏•‡∏∞‡∏î‡∏≥‡πÄ‡∏ô‡∏¥‡∏ô‡∏Å‡∏≤‡∏£‡∏≠‡∏ô‡∏∏‡∏°‡∏±‡∏ï‡∏¥‡∏Å‡∏≤‡∏£‡∏à‡∏≠‡∏á‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡πà‡∏≠‡πÑ‡∏õ</p>
                        <hr>
                        <p style='font-size: 0.9em; color: #777;'>‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡∏ô‡∏µ‡πâ‡∏ñ‡∏π‡∏Å‡∏™‡πà‡∏á‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥</p>
                    </div>
                </div>
            ";

            $adminMail->send();
        } catch (Exception $e) {
            // ‡∏´‡∏≤‡∏Å‡∏™‡πà‡∏á‡∏≠‡∏µ‡πÄ‡∏°‡∏•‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à ‡πÑ‡∏°‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏´‡∏¢‡∏∏‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô ‡πÅ‡∏Ñ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å log ‡πÑ‡∏ß‡πâ
            error_log("Slip Upload Mailer Error: " . $adminMail->ErrorInfo);
        }

        if ($stmt_update->execute()) {
            echo json_encode(['success' => true, 'message' => '‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à']);
        } else {
            echo json_encode(['success' => false, 'message' => '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ']);
        }
        $stmt_update->close();
    } else {
        echo json_encode(['success' => false, 'message' => 'Database prepare error.']);
    }
} else {
    echo json_encode(['success' => false, 'message' => '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÑ‡∏ü‡∏•‡πå‡πÑ‡∏î‡πâ']);
}

$conn->close();
?>
